## **LocalAgentWeaver システム開発設計書 兼 Claude Code実装指示書**

### 1. プロジェクト概要

#### 1.1. プロジェクト名
LocalAgentWeaver

#### 1.2. コンセプト
ローカル環境で動作するLLM（Ollama/LM Studio）と連携し、チームでのドキュメントベースの対話やアイデア創出を支援する、セキュアなAIエージェントプラットフォーム。ユーザーはプロジェクトを作成し、ドキュメントをアップロードし、AIエージェントからなる「チーム」と対話することで、高度な情報分析やコンテンツ生成を行う。

#### 1.3. 主要機能
- ユーザー認証・管理
- プロジェクト管理
- ローカルLLM（Ollama/LM Studio）との連携チャット機能
- ドキュメントアップロードとRAG（Retrieval-Augmented Generation）機能
- AIエージェントチームの作成・管理・選択
- プロジェクトの共有機能

---

### 2. システムアーキテクチャ

#### 2.1. システム構成図
LocalAgentWeaverは、フロントエンド、バックエンド、データベース、そしてユーザーのローカル環境で動作するLLM実行環境から構成されます。バックエンドは、ビジネスロジックの中核を担い、LLM実行環境へのリクエストを中継・管理します。

```
 +-----------+      +----------------------+      +------------------+
 |           | HTTP |                      |      |                  |
 |  ユーザー   |----->|   Frontend (Next.js) |----->|  Backend (FastAPI) |
 | (ブラウザ)  |      | (UI/UX)              |      | (ビジネスロジック) |
 +-----------+      +-----------+----------+      +---------+--------+
                                |                          |
            (WebSocketリアルタイム通信)                      | (API Call)
                                |                          |
                                |          +---------------v----------------+
                                |          |                                |
                                |          |    LLM実行環境 (ローカル)      |
                                +--------->|     - Ollama                   |
                                           |     - LM Studio                |
                                           |                                |
                                           +--------------------------------+
                                                           ^
                                                           |
                                       +-------------------+--------------------+
                                       |                   |                    |
                              +--------v---------+ +-------v--------+
                              |                  | |                |
                              |    PostgreSQL    | |      Redis     |
                              |  (データ永続化)  | | (キャッシュ)   |
                              +------------------+ +----------------+
```

#### 2.2. 技術スタック
| カテゴリ | 技術選定 | 理由 |
| :--- | :--- | :--- |
| **バックエンド** | Python, FastAPI | LLMとの親和性が高く、高性能。WebSocketによるリアルタイム通信に対応。 |
| **フロントエンド** | TypeScript, React, Next.js | 型安全で堅牢な開発が可能。SSR/SSGによる高いパフォーマンスを実現。 |
| **データベース** | PostgreSQL | リレーショナルデータの永続化に適した、信頼性の高いOSS RDBMS。 |
| **キャッシュ** | Redis | セッション管理や高速なデータキャッシュによるパフォーマンス向上。 |
| **UIフレームワーク** | Tailwind CSS, Shadcn/ui | 高いカスタマイズ性とコンポーネント指向による効率的なUI開発。 |
| **LLM実行環境** | **Ollama / LM Studio (設定により切替可能)** | **ローカル環境でセキュアにLLMを実行するため。ユーザーの既存環境や好みのモデルに応じて選択肢を提供。** |
| **コンテナ化** | Docker, Docker Compose | 開発・本番環境の差異をなくし、ポータビリティを確保。 |
| **テスト** | Pytest (BE), Jest/Playwright (FE) | TDDを実践し、コード品質を担保するための標準的なテストフレームワーク。|

#### 2.3. `docker-compose.yml` の構成
プロジェクトのサービス群は`docker-compose.yml`で定義される。特にLLM実行環境として、OllamaはDockerサービスとして管理可能とする。

```yaml
# docker-compose.yml の構成概要
version: '3.8'
services:
  backend: ...
  frontend: ...
  db: ...
  redis: ...

  # プロファイル機能により、選択的に起動されるOllamaサービス
  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434"
    volumes:
      - ./ollama-data:/root/.ollama
    # GPUを利用する場合の推奨設定 (NVIDIA Container Toolkitが必要)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    profiles:
      - ollama # '--profile ollama' オプションで起動
```

#### 2.4. ファイル・ディレクトリ構造
フィーチャーベースのディレクトリ構造を採用し、機能ごとの独立性と保守性を高める。

```plaintext
LocalAgentWeaver/
├── backend/
│   ├── app/
│   │   ├── features/          # 機能ごとのモジュール (auth, projects, teams, chat)
│   │   ├── core/              # 設定、DB接続など共通のコア機能
│   │   ├── models/            # SQLAlchemyのデータモデル定義
│   │   └── tests/             # テストコード
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── features/          # 機能ごとのコンポーネント、フック、APIクライアント
│   │   ├── components/ui/     # Shadcn/uiによる共通UIコンポーネント
│   │   ├── hooks/             # 共通カスタムフック
│   │   └── utils/             # 共通ユーティリティ関数
│   ├── package.json
│   └── Dockerfile
├── scripts/                   # セットアップ用スクリプト
│   ├── setup-dev.sh
│   └── setup-prod.sh
├── .env.example               # 環境変数テンプレート
└── docker-compose.yml         # 開発・本番環境定義
```

---

### 3. UI/UX設計 (詳細仕様)

**基本方針:** 本システムのUIは、ドキュメントという「コンテキスト」を管理しながら、AIチームと「対話」することに最適化された設計とする。複雑な操作を排し、チーム選択や編集といった主要なワークフローを直感的かつ情報豊かに提供する。

#### 3.1. 画面構成図

```
                                      +--------------------------------+
                                      |                                |
[未ログイン] -------------------------> |  ログイン / 新規登録画面        |
                                      |  (LAW-SC-010)                  |
                                      +---------------+----------------+
                                                      | (認証成功)
                                                      |
                          +---------------------------v----------------------------+
                          |                                                        |
                          |      ダッシュボード (プロジェクト一覧画面)             |
                          |      (LAW-SC-100)                                      |
                          |                                                        |
                          +---------------------------+----------------------------+
                                                      | (プロジェクト選択)
                                                      |
+-----------------------------------------------------v------------------------------------------------------+
|                                                                                                              |
|                                       メイン画面 (チャット / プロジェクト編集)                               |
|                                       (LAW-SC-200)                                                           |
|                                                                                                              |
+-----------------------------------------------------+--------------------------------------------------------+
              | (左サイドバーのチーム名をクリック)              ^
              |                                               | (チーム選択後)
              v                                               |
+---------------------------+---------------------------------+---------------------------+
|                           |                                 |                           |
|  チーム選択モーダル       | <--(新規作成/編集)-->            |  チーム編集モーダル       |
|  (LAW-SC-215)             |                                 |  (LAW-SC-210)             |
|                           |                                 |                           |
+---------------------------+---------------------------------+---------------------------+
```

#### 3.2. 各画面仕様

##### 3.2.1. ログイン / 新規登録画面 - `LAW-SC-010`
*   **概要:** ユーザー認証を行うためのエントリーポイント。タブでログインと新規登録を切り替えるシンプルなフォーム。

##### 3.2.2. ダッシュボード（プロジェクト一覧）画面 - `LAW-SC-100`
*   **概要:** ユーザーが関わるプロジェクトを管理するハブ画面。プロジェクトをカード形式で一覧表示し、新規作成や検索が可能。

##### 3.2.3. メイン画面（チャット / プロジェクト編集） - `LAW-SC-200`
*   **概要:** アプリケーションの中核画面。3カラムレイアウトを採用。
*   **左サイドバー:**
    *   **ドキュメント管理:** ファイルアップロード、コンテキストに含めるかの有効/無効切り替え。
    *   **チーム選択エリア:** 現在のチーム名を表示するクリック可能なエリア。クリックで**チーム選択モーダル (`LAW-SC-215`)** を開く。
*   **中央エリア:** メインのチャットUI。LLMモデル選択、チャット履歴、プロンプト入力欄を配置。
*   **右サイドバー:** 引用・出典表示など補助情報を表示。

##### 3.2.4. チーム選択モーダル - `LAW-SC-215`
*   **概要:** チームの概要を確認しながら、プロジェクトで使用するAIチームを選択するモーダル。
*   **ワイヤーフレーム:**
    ```
    +--------------------------------------------------------------------------+
    |  [ チームを選択 ]                                                          |
    |--------------------------------------------------------------------------|
    |  [ 🔍 チームを検索... ]  [ + 新しいチームを作成 ]                          |
    |--------------------------------------------------------------------------|
    |  +--------------------------------------------------------------------+  |
    |  | [ 開発チーム ] (現在選択中)                             [ ⚙️ ]      |  |
    |  |--------------------------------------------------------------------|  |
    |  | 役割: ソフトウェア開発に関する質問に答える専門家チームです。         |  |
    |  | エージェント: [ シニアデベロッパー ] [ QAエンジニア ]                |  |
    |  +--------------------------------------------------------------------+  |
    |  ... (他のチームタイル) ...                                             |
    |--------------------------------------------------------------------------|
    |                                                         [ 閉じる ]       |
    +--------------------------------------------------------------------------+
    ```
*   **機能:**
    *   **チームタイルクリック:** チームを選択しモーダルを閉じる。
    *   **`+ 新しいチームを作成` ボタン:** `LAW-SC-210`を新規作成モードで開く。
    *   **`⚙️` (編集) ボタン:** `LAW-SC-210`を編集モードで開く。

##### 3.2.5. チーム編集モーダル - `LAW-SC-210`
*   **概要:** AIエージェントを組み合わせて独自のチームを新規作成、または編集するモーダル。
*   **ワイヤーフレーム:**
    ```
    +--------------------------------------------------------------------------+
    |  [ チームを編集 ]                                             [ × ]      |
    |--------------------------------------------------------------------------|
    |  チーム名: [ input: 開発チーム ]                                         |
    |  チームの役割・目的: [ textarea: このチームは... ]                       |
    |  ----------------------------------------------------------------------  |
    |  [ エージェント ]                                                        |
    |  +--------------------------------------------------------------------+  |
    |  | [エージェント 1] [🗑️] エージェント名: [ input ] 役割: [ textarea ]  |  |
    |  +--------------------------------------------------------------------+  |
    |  [ + エージェントを追加 ]                                                |
    |  ----------------------------------------------------------------------  |
    |  [ 他のチームからエージェントをコピー ]                                  |
    |  コピー元チーム: [ 事業戦略チーム ▼ ]                                    |
    |  +--------------------------------------------------------------------+  |
    |  | 役割: 新規事業の立案と市場分析を行います... (リードオンリー)         |  |
    |  +--------------------------------------------------------------------+  |
    |  エージェント: [ ✅ マーケター ] [ ✅ データアナリスト ]                 |
    |  [ 選択したエージェントをコピー ]                                        |
    |--------------------------------------------------------------------------|
    |  [ キャンセル ]                                    [ 保存 ]              |
    +--------------------------------------------------------------------------+
    ```
*   **機能:**
    *   チームの基本情報（名称、役割）を定義。
    *   エージェントを動的に追加・削除。
    *   他のチームからエージェントを役割を確認しながらコピー。

---

### 4. 実装上の共通指針（コーディング規約）

- **開発手法:** **テスト駆動開発（TDD）**を厳守する。機能実装前にテストコードを作成すること。
- **認証:** メールアドレスとパスワードによる認証。認証トークンには**JWT**を使用する。
- **LLMプロバイダー:** **Ollama**および**LM Studio**に対応。設定ファイル (`.env`) とUIの両方から接続先を切り替え可能な設計とする。
- **設定管理:** DB接続情報、LLM接続先、ファイルアップロード上限（デフォルト30MB）などの設定値は、環境変数 (`.env`) で管理する。
- **デプロイ:** **Docker**および**docker-compose**を前提とする。Windows/Linuxの両環境で動作すること。
- **ログ:** **構造化ログ**を出力する。リクエストIDなどを付与し、処理の追跡を容易にすること。
- **コード品質:** 可読性と保守性を最優先する。型ヒントを徹底し、静的解析ツールを導入する。
- **セキュリティ:** ファイルアップロード時のMIMEタイプ検証、APIへのCORS設定とレート制限、ユーザー入力のサニタイズ・バリデーションを行う。

---

### 5. 開発ロードマップ（フェーズ別実装計画）

#### ■ MVP（最小実用製品） - 目標期間: 2-3週間
**目標:** 基本的な認証、プロジェクト管理、LLMとの対話機能を持つコアシステムを構築する。

| No. | カテゴリ | 実装項目 |
| :-- | :--- | :--- |
| 1 | 共通 | プロジェクト構造、Docker環境、CI/CDパイプラインの初期セットアップ |
| 2 | バックエンド | **認証機能:** ユーザー登録/ログインAPI (JWT発行) |
| 3 | バックエンド | **プロジェクト管理機能:** プロジェクトのCRUD API |
| 4 | バックエンド | **基本チャット機能:** Ollama/LMStudioへのプロキシAPI、履歴保存機能 |
| 5 | フロントエンド | **認証画面 (`LAW-SC-010`)、プロジェクト一覧画面 (`LAW-SC-100`)** |
| 6 | フロントエンド | **基本メイン画面 (`LAW-SC-200`)**: シンプルなチャットUIのみ実装 |

#### ■ PHASE 1: コア機能実装 - 目標期間: 3-4週間
**目標:** チーム管理とドキュメント連携機能を追加し、システムのコアバリューを確立する。

| No. | カテゴリ | 実装項目 |
| :-- | :--- | :--- |
| 1 | バックエンド | **チーム・エージェント管理機能:** CRUD API、プリセット定義 |
| 2 | バックエンド | **ドキュメント処理:** ファイルアップロードAPI (PDF, TXT, MD)、ベクトル化 |
| 3 | バックエンド | **RAG機能:** アップロードされたドキュメントをコンテキストとして利用するAPI |
| 4 | フロントエンド | **チーム管理UI:** チーム選択・編集モーダル (`LAW-SC-215`, `LAW-SC-210`) |
| 5 | フロントエンド | **ドキュメント管理UI:** ファイルアップロード、有効/無効切り替えUI |
| 6 | フロントエンド | **LLMモデル切替UI:** チャット画面からリアルタイムでモデルを切り替える機能 |

#### ■ PHASE 2: 高度な機能実装 - 目標期間: 4-5週間
**目標:** ユーザー体験を向上させる高度な機能と共有機能を追加する。

| No. | カテゴリ | 実装項目 |
| :-- | :--- | :--- |
| 1 | バックエンド | **プロジェクト共有機能:** ユーザー間でのプロジェクト共有、権限管理API |
| 2 | バックエンド | **高度なチャット機能:** 応答に対する出典・引用元の特定API |
| 3 | フロントエンド | **共有機能UI:** プロジェクト共有設定画面、共有されたプロジェクト一覧 |
| 4 | フロントエンド | **引用表示UI:** チャット応答に出典元ドキュメントへのリンクやハイライトを表示 |
| 5 | UI/UX | レスポンシブデザイン対応、ダークモード実装、アクセシビリティ向上 |

#### ■ PHASE 3: 企業グレード機能 - 目標期間: 3-4週間
**目標:** パフォーマンス、運用性、セキュリティを強化し、実運用に耐えうる品質を確保する。

| No. | カテゴリ | 実装項目 |
| :-- | :--- | :--- |
| 1 | パフォーマンス | DBクエリ最適化、Redisによるキャッシング戦略の導入 |
| 2 | 運用・監視 | 構造化ログ管理システムの導入、エラー監視、ヘルスチェックAPI |
| 3 | セキュリティ | ファイルアップロードのセキュリティスキャン、APIレート制限強化 |

---

### 6. セットアップスクリプト仕様

#### 6.1. `scripts/setup-dev.sh`（開発環境セットアップスクリプト）

**目的:**
開発者が初回環境構築時に実行するインタラクティブなスクリプト。**使用するLLM環境を選択**させ、Docker環境の構築と接続テストまでを自動化する。

**実行手順:**
1.  **LLM環境の選択 (対話式):**
    *   スクリプト実行時、ユーザーに以下の選択肢を提示する。
        1.  `Ollama (Dockerで自動セットアップ)`
        2.  `LM Studio (手動でアプリを起動)`
        3.  `スキップ (後で手動設定)`
    *   ユーザーの選択に応じて、以降のDockerコマンドやテスト内容が分岐する。

2.  **前提条件チェック:**
    *   DockerおよびDocker Composeがインストールされ、正常に動作しているかを確認する。
    *   システムで使用する主要ポート（5432, 6379, 8000, 3000）に競合がないかチェックする。
    *   Ollama選択時は、NVIDIA Container Toolkitのインストールの有無を確認し、なければGPU利用に必要である旨を案内する。

3.  **環境設定:**
    *   プロジェクトルートに `.env.example` から `.env` ファイルを自動生成する。
    *   JWTの秘密鍵やデータベースの認証情報などをランダムな値で初期設定する。
    *   ユーザーが選択したLLM環境に応じて、接続先のデフォルト値（Ollama: `http://localhost:11434`, LM Studio: `http://localhost:1234`）を`.env`ファイルに書き込む。

4.  **Docker環境構築:**
    *   **Ollamaを選択した場合:** `docker-compose --profile ollama up -d --build` コマンドを実行し、基本サービス群に加えてOllamaサービスも起動する。
    *   **LM Studioまたはスキップを選択した場合:** `docker-compose up -d --build` コマンドを実行し、基本サービス群のみを起動する。
    *   バックエンドコンテナ内で、データベースマイグレーションを自動実行する。

5.  **LLM接続テスト:**
    *   ユーザーが選択したLLM環境（OllamaまたはLM Studio）に対してのみ接続テストを実行する。
    *   接続に成功した場合、利用可能なモデル一覧を取得し、ターミナルに表示する。
    *   接続に失敗した場合は、エラーメッセージと共に、ユーザーが確認すべき事項を案内する。（例:「LM Studioアプリを起動してください」「`docker-compose logs ollama`でOllamaコンテナのログを確認してください」）

**出力例 (Ollama選択時):**
```bash
$ ./scripts/setup-dev.sh
どのLLM実行環境を使用しますか？
1) Ollama (Dockerで自動セットアップ)
2) LM Studio (手動でアプリを起動)
3) スキップ (後で手動設定)
#? 1

✅ Docker環境チェック完了
📝 .envファイルを生成しました
🐳 Docker環境とOllamaサービスを構築中... (`--profile ollama` を使用)
✅ PostgreSQL接続確認完了
✅ Redis接続確認完了
🤖 LLM接続テスト中 (Ollama)...
  - Ollama (localhost:11434): ✅ 接続成功
    利用可能モデル: llama3, codellama
🚀 開発環境構築完了！
   Frontend: http://localhost:3000
   Backend API: http://localhost:8000
```

#### 6.2. `scripts/setup-prod.sh`（本番環境セットアップスクリプト）

**目的:**
本番環境での安全なデプロイを支援するスクリプト。手動操作によるミスを減らし、セキュリティ設定とパフォーマンス最適化を体系的に行う。

**実行手順:**
1.  **セキュリティチェック:**
    *   SSL証明書が指定されたパスに存在するか確認する。
    *   本番用の環境変数がデフォルト値のままでないか、また十分な強度を持つかチェックする。
    *   ファイアウォールが有効であり、必要なポート（80, 443）のみが公開されているか確認する。
2.  **本番環境構築:**
    *   `docker-compose.prod.yml` など、本番用に最適化されたComposeファイルを使用してコンテナを起動する。
    *   nginxリバースプロキシのコンテナを起動し、SSL終端と適切なルーティングを設定する。
    *   Dockerのログローテーション設定を適用する。
3.  **パフォーマンス最適化:**
    *   PostgreSQLのインデックスを最適化するコマンドを実行する。
    *   Redisのメモリ使用量上限など、本番に適した設定を適用する。
    *   アプリケーションキャッシュをクリアし、最新の状態で起動させる。
4.  **監視・ヘルスチェック:**
    *   デプロイ後、各サービスのヘルスチェックエンドポイントにリクエストを送信し、正常な応答が返ってくるか確認する。
    *   ログ監視ツールやエラー監視ツールとの連携設定が正しく行われているか確認する。

---

### 7. Claude Codeへの具体的な指示プロンプト例

#### 7.1. プロジェクト開始時の指示
```prompt
これから「LocalAgentWeaver」という新しいWebアプリケーションを開発します。
上記に提示した【@CLAUDE.md】をあなたの知識ベースとして、すべての開発を行ってください。

まずは【開発ロードマップ】の【MVP】フェーズから着手します。
以下のタスクを、テスト駆動開発（TDD）の原則に従って、高品質で保守性の高いコードで実装してください。

1.  **プロジェクト初期セットアップ:**
    - 設計書通りのファイル・ディレクトリ構造を生成してください。
    - FastAPI, Next.js, PostgreSQL, Redis, そしてプロファイルで管理されるOllamaサービスを含む `docker-compose.yml` を【2.3. `docker-compose.yml` の構成】に従って作成してください。
    - 【6.1. `scripts/setup-dev.sh`（開発環境セットアップスクリプト）】の仕様に基づき、対話式でLLM環境を選択できる開発環境構築用のシェルスクリプトを作成してください。

2.  **バックエンド (FastAPI) の実装:**
    - `features/auth` に、JWTを用いたユーザー登録・ログインAPIを実装してください。
    - `features/projects` に、プロジェクトのCRUD APIを実装してください。
    - 上記機能に対応するpytestのユニットテストコードも同時に生成してください。

上記が完了したら、次にフロントエンドの実装を指示します。
```