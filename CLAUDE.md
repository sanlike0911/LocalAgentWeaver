## **LocalAgentWeaver システム開発設計書 兼 Claude Code実装指示書**

### 1. プロジェクト概要

#### 1.1. プロジェクト名
LocalAgentWeaver

#### 1.2. コンセプト
ローカル環境で動作するLLM（Ollama/LM Studio）と連携し、チームでのドキュメントベースの対話やアイデア創出を支援する、セキュアなAIエージェントプラットフォーム。ユーザーはプロジェクトを作成し、ドキュメントをアップロードし、AIエージェントからなる「チーム」と対話することで、高度な情報分析やコンテンツ生成を行う。

#### 1.3. 主要機能
- ユーザー認証・管理
- プロジェクト管理
- ローカルLLM（Ollama/LM Studio）との連携チャット機能
- ドキュメントアップロードとRAG（Retrieval-Augmented Generation）機能
- AIエージェントチームの作成・管理
- プロジェクトの共有機能

---

### 2. システムアーキテクチャ

#### 2.1. 技術スタック

| カテゴリ           | 技術選定                                   | 理由                                                                 |
| ------------------ | ------------------------------------------ | -------------------------------------------------------------------- |
| **バックエンド**   | Python, FastAPI                            | LLMとの親和性が高く、高性能。WebSocketによるリアルタイム通信に対応。   |
| **フロントエンド** | TypeScript, React, Next.js                 | 型安全で堅牢な開発が可能。SSR/SSGによる高いパフォーマンスを実現。    |
| **データベース**   | PostgreSQL                                 | リレーショナルデータの永続化に適した、信頼性の高いOSS RDBMS。        |
| **キャッシュ**     | Redis                                      | セッション管理や高速なデータキャッシュによるパフォーマンス向上。     |
| **UIフレームワーク**| Tailwind CSS, Shadcn/ui                  | 高いカスタマイズ性とコンポーネント指向による効率的なUI開発。         |
| **コンテナ化**     | Docker, Docker Compose                     | 開発・本番環境の差異をなくし、ポータビリティを確保。                 |
| **テスト**         | Pytest (BE), Jest/Playwright (FE)          | TDDを実践し、コード品質を担保するための標準的なテストフレームワーク。|

#### 2.2. ファイル・ディレクトリ構造
フィーチャーベースのディレクトリ構造を採用し、機能ごとの独立性と保守性を高める。

```plaintext
LocalAgentWeaver/
├── backend/
│   ├── app/
│   │   ├── features/          # 機能ごとのモジュール (認証、プロジェクト、チャット等)
│   │   │   ├── auth/
│   │   │   ├── projects/
│   │   │   └── chat/
│   │   ├── core/              # 設定、DB接続など共通のコア機能
│   │   ├── models/            # SQLAlchemyのデータモデル定義
│   │   ├── services/          # 複数フィーチャーにまたがるビジネスロジック
│   │   └── tests/             # テストコード
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── features/          # 機能ごとのコンポーネント、フック、APIクライアント
│   │   ├── components/ui/     # Shadcn/uiによる共通UIコンポーネント
│   │   ├── hooks/             # 共通カスタムフック
│   │   └── utils/             # 共通ユーティリティ関数
│   ├── package.json
│   └── Dockerfile
├── scripts/                   # セットアップ用スクリプト
│   ├── setup-dev.sh
│   └── setup-prod.sh
├── .env.example               # 環境変数テンプレート
└── docker-compose.yml         # 開発・本番環境定義
```

---

### 3. UI/UX設計

**基本方針:** 「@docs/nodebookLM(r1).md」のコンセプトをベースとし、本システムの機能に合わせて最適化する。

#### 3.1. 主要画面構成
1.  **ログイン/新規登録画面:** シンプルなメール・パスワード入力フォーム。
2.  **ダッシュボード（プロジェクト一覧）画面:** ユーザーが参加しているプロジェクトをカード形式で一覧表示。新規作成、検索、フィルタリング機能を持つ。
3.  **メイン画面（チャット/プロジェクト編集画面）:**
    *   **左サイドバー:**
        *   アップロード済みドキュメント一覧（有効/無効切り替え）
        *   AIエージェントチーム選択/編集エリア
    *   **中央エリア:**
        *   チャットインターフェース（メッセージ履歴表示）
        *   ユーザーのプロンプト入力欄
    *   **右サイドバー（任意表示）:**
        *   チャット応答の引用元/出典ドキュメント表示エリア
        *   現在選択中のLLMモデル情報

#### 3.2. 画面レイアウト
「@docs/nodebookLM(r1).md」参照

---

### 4. 実装上の共通指針（コーディング規約）

- **開発手法:** **テスト駆動開発（TDD）**を厳守する。機能実装前にテストコードを作成すること。
- **認証:** メールアドレスとパスワードによる認証。認証トークンには**JWT**を使用する。
- **LLMプロバイダー:** **Ollama**および**LM Studio**に対応。設定ファイル (`.env`) とUIの両方から接続先を切り替え可能な設計とする。
- **設定管理:** DB接続情報、LLM接続先、ファイルアップロード上限（デフォルト30MB）などの設定値は、環境変数 (`.env`) と設定ファイル (`config.yaml`等) で管理する。
- **デプロイ:** **Docker**および**docker-compose**を前提とする。Windows/Linuxの両環境で動作すること。
- **ログ:** **構造化ログ**を出力する。リクエストIDなどを付与し、処理の追跡を容易にすること。例外発生時は詳細なログを記録し、ユーザーにはフレンドリーなエラーメッセージを返す。
- **コード品質:** 可読性と保守性を最優先する。型ヒント（Python/TypeScript）を徹底し、静的解析ツールを導入する。
- **セキュリティ:**
    - ファイルアップロード時はMIMEタイプや拡張子を検証する。
    - APIには適切なCORS設定とレート制限を設ける。
    - すべてのユーザー入力はサニタイズ・バリデーションを行う。

---

### 5. 開発ロードマップ（フェーズ別実装計画）

#### ■ MVP（最小実用製品） - 目標期間: 2-3週間
**目標:** 基本的な認証、プロジェクト管理、LLMとの対話機能を持つコアシステムを構築する。

| No. | カテゴリ | 実装項目                                                               | テスト要件                                     |
| --- | -------- | ---------------------------------------------------------------------- | ---------------------------------------------- |
| 1   | 共通     | プロジェクト構造、Docker環境、CI/CDパイプラインの初期セットアップ        | `setup-dev.sh`が正常に動作すること             |
| 2   | バックエンド | **認証機能:** ユーザー登録/ログインAPI (JWT発行)                       | 認証エンドポイントのユニットテスト(pytest)     |
| 3   | バックエンド | **プロジェクト管理機能:** プロジェクトのCRUD API                     | プロジェクトAPIのユニットテスト(pytest)        |
| 4   | バックエンド | **基本チャット機能:** Ollama/LMStudioへのプロキシAPI、履歴保存機能     | LLM接続部分のモックテスト                     |
| 5   | フロントエンド | **認証画面:** ログイン、新規登録フォームとAPI連携                    | ログインフローのE2Eテスト(Playwright)          |
| 6   | フロントエンド | **プロジェクト一覧画面:** プロジェクトの表示、作成、削除UI           | プロジェクト操作のE2Eテスト                    |
| 7   | フロントエンド | **チャット画面:** シンプルなチャットUI（メッセージ送受信、履歴表示） | メッセージ送受信の統合テスト                   |

#### ■ PHASE 1: コア機能実装 - 目標期間: 3-4週間
**目標:** チーム管理とドキュメント連携機能を追加し、システムのコアバリューを確立する。

| No. | カテゴリ | 実装項目                                                               |
| --- | -------- | ---------------------------------------------------------------------- |
| 1   | バックエンド | **チーム管理機能:** AIエージェントとチームのCRUD API、プリセット定義     |
| 2   | バックエンド | **ドキュメント処理:** ファイルアップロードAPI (PDF, TXT, MD)、ベクトル化 |
| 3   | バックエンド | **RAG機能:** アップロードされたドキュメントをコンテキストとして利用するAPI |
| 4   | フロントエンド | **チーム管理UI:** チームの作成、エージェントの割り当てUI                |
| 5   | フロントエンド | **ドキュメント管理UI:** ファイルアップロード、有効/無効切り替えUI      |
| 6   | フロントエンド | **LLMモデル切替UI:** チャット画面からリアルタイムでモデルを切り替える機能 |

#### ■ PHASE 2: 高度な機能実装 - 目標期間: 4-5週間
**目標:** ユーザー体験を向上させる高度な機能と共有機能を追加する。

| No. | カテゴリ | 実装項目                                                               |
| --- | -------- | ---------------------------------------------------------------------- |
| 1   | バックエンド | **プロジェクト共有機能:** ユーザー間でのプロジェクト共有、権限管理API  |
| 2   | バックエンド | **高度なチャット機能:** 応答に対する出典・引用元の特定API              |
| 3   | フロントエンド | **共有機能UI:** プロジェクト共有設定画面、共有されたプロジェクト一覧     |
| 4   | フロントエンド | **引用表示UI:** チャット応答に出典元ドキュメントへのリンクやハイライトを表示 |
| 5   | UI/UX    | レスポンシブデザイン対応、ダークモード実装、アクセシビリティ向上       |

#### ■ PHASE 3: 企業グレード機能 - 目標期間: 3-4週間
**目標:** パフォーマンス、運用性、セキュリティを強化し、実運用に耐えうる品質を確保する。

| No. | カテゴリ | 実装項目                                                               |
| --- | -------- | ---------------------------------------------------------------------- |
| 1   | パフォーマンス | DBクエリ最適化、Redisによるキャッシング戦略の導入                    |
| 2   | パフォーマンス | WebSocketによるリアルタイム通信の安定化、4人程度の同時接続ストレステスト |
| 3   | 運用・監視   | 構造化ログ管理システムの導入、エラー監視（Sentry等）、ヘルスチェックAPI |
| 4   | セキュリティ | ファイルアップロードのセキュリティスキャン、APIレート制限、CORS詳細設定 |

---

### 6. Claude Codeへの具体的な指示プロンプト例

#### 6.1. プロジェクト開始時の指示
```prompt
これから「LocalAgentWeaver」という新しいWebアプリケーションを開発します。上記に提示した【LocalAgentWeaver システム開発設計書】をあなたの知識ベースとして、すべての開発を行ってください。

まずは【開発ロードマップ】の【MVP】フェーズから着手します。
以下のタスクを、テスト駆動開発（TDD）の原則に従って、高品質で保守性の高いコードで実装してください。

1.  **プロジェクト初期セットアップ:**
    - 設計書通りのファイル・ディレクトリ構造を生成してください。
    - FastAPI, Next.js, PostgreSQL, Redisを含む `docker-compose.yml` を作成してください。
    - 開発環境を構築するための `scripts/setup-dev.sh` を作成してください。

2.  **バックエンド (FastAPI) の実装:**
    - `features/auth` に、JWTを用いたユーザー登録・ログインAPIを実装してください。パスワードは適切にハッシュ化してください。
    - `features/projects` に、プロジェクトのCRUD APIを実装してください。APIは認証が必須です。
    - 上記機能に対応するpytestのユニットテストコードも同時に生成してください。

上記が完了したら、次にフロントエンドの実装を指示します。
```

#### 6.2. フロントエンド実装の指示（上記に続けて）
```prompt
素晴らしいバックエンドの実装です。次に、MVPのフロントエンド部分を実装してください。

1.  **フロントエンド (Next.js + TypeScript) の実装:**
    - 先ほど作成したバックエンドAPIと連携する、ログイン画面と新規登録画面を実装してください。入力バリデーションとエラー表示もお願いします。
    - ログイン後、プロジェクト一覧を表示するダッシュボード画面を実装してください。プロジェクトの作成と削除ができるようにしてください。
    - プロジェクトを選択すると遷移する、基本的なチャット画面を実装してください。UIは【UI/UX設計】の項を参照してください。

コンポーネントはShadcn/uiを使用して、機能ごとに適切に分割してください。
```